module tables
  use params, only : dp
  use utils, only: linear_interp
  use phys, only: H2O_L_sublimation
  implicit none

  real(dp) :: Ttp = 273.16
  real(dp) :: T_end  = 647.! Just below critical temperature
  integer :: n_table = 50
  
  real(dp), parameter :: T(49) = (/273.16   , 280.79134694, 288.42269388, 296.05404082,&
       303.68538776, 311.31673469, 318.94808163, 326.57942857,&
       334.21077551, 341.84212245, 349.47346939, 357.10481633,&
       364.73616327, 372.3675102 , 379.99885714, 387.63020408,&
       395.26155102, 402.89289796, 410.5242449 , 418.15559184,&
       425.78693878, 433.41828571, 441.04963265, 448.68097959,&
       456.31232653, 463.94367347, 471.57502041, 479.20636735,&
       486.83771429, 494.46906122, 502.10040816, 509.7317551 ,&
       517.36310204, 524.99444898, 532.62579592, 540.25714286,&
       547.8884898 , 555.51983673, 563.15118367, 570.78253061,&
       578.41387755, 586.04522449, 593.67657143, 601.30791837,&
       608.93926531, 616.57061224, 624.20195918, 631.83330612,&
       639.46465306/)

  real(dp), parameter :: lheat(49) = (/2500537.992720097, 2482839.9845154616,2464924.549801353,&
       2446870.4063889873,2428716.9993550396,2410476.4281226317,&
       2392141.8576981686,2373693.4045157116,2355102.225994891,&
       2336333.3440693025,2317347.58344357,2298102.8941141665,&
       2278555.2457944946,2258659.222272561,2238368.4009194765,&
       2217635.5723345308,2196412.8342096675,2174651.5794327096,&
       2152302.389309872,2129314.8371038437,2105637.2037150585,&
       2081216.1053961227,2055996.0321805072,2029918.7946571708,&
       2002922.8753449027,1974942.6787642944,1945907.670911796,&
       1915741.3936820417,1884360.3321936703,1851672.602035535,&
       1817576.4078452894,1781958.2023893306,1744690.443404617,&
       1705628.7991290821,1664608.5850239818,1621440.1110193927,&
       1575902.4591775925,1527734.9582067847,1476625.2050181734,&
       1422191.7739563962, 1363958.4911911818,1301314.785717382,&
       1233451.918479445,1159254.7924653592,1077105.2789987705,&
       984489.844927971,877106.1104059853,746366.06771214,&
       569229.6959539498/)

  real(dp), parameter :: satur(50) = (/6.11657070e+02, 1.04700395e+03, 1.73586788e+03, 2.79466788e+03,&
       4.37920771e+03, 6.69301793e+03, 9.99615270e+03, 1.46142123e+04,&
       2.09473490e+04, 2.94790161e+04, 4.07842377e+04, 5.55372020e+04,&
       7.45180209e+04, 9.86185378e+04, 1.28847110e+05, 1.66332336e+05,&
       2.12325737e+05, 2.68203431e+05, 3.35466882e+05, 4.15742812e+05,&
       5.10782391e+05, 6.22459837e+05, 7.52770551e+05, 9.03828931e+05,&
       1.07786602e+06, 1.27722709e+06, 1.50436941e+06, 1.76186025e+06,&
       2.05237530e+06, 2.37869784e+06, 2.74371868e+06, 3.15043722e+06,&
       3.60196390e+06, 4.10152446e+06, 4.65246639e+06, 5.25826816e+06,&
       5.92255199e+06, 6.64910116e+06, 7.44188315e+06, 8.30508042e+06,&
       9.24313145e+06, 1.02607859e+07, 1.13631798e+07, 1.25559402e+07,&
       1.38453372e+07, 1.52385141e+07, 1.67438702e+07, 1.83717818e+07, &
       2.01363422e+07, 2.20640000e+07/)

  real(dp), parameter :: phase_grad(49) = (/19.84498763, 19.17337147, &
       18.53757655, 17.93520481, 17.36408297,&
       16.82223398, 16.30785266, 15.819285  , 15.35501047, 14.91362679,&
       14.49383689, 14.09443772, 13.71431049, 13.35241236, 13.00776922,&
       12.6794694 , 12.36665832, 12.06853382, 11.78434214, 11.51337446,&
       11.254964  , 11.00848346, 10.77334297, 10.54898836, 10.33489974,&
       10.13059049,  9.93560646,  9.74952556,  9.57195763,  9.40254465,&
        9.24096135,  9.08691622,  8.940153  ,  8.80045284,  8.66763718,&
        8.54157171,  8.42217156,  8.30940852,  8.20332077,  8.1040267 ,&
        8.01174465,  7.92682246,  7.84978332,  7.78140111,  7.72283313,&
        7.67587698,  7.64353758,  7.63155818,  7.65437086/)


  ! Chosen to be linearly spaced between T_tp and T_crit-small_number for ease of lookup
  ! Data taken from Wagner + Pruss 2002, specifically data is on the liquid-gas phase boundary,
  ! but we are approximating all quantities are const. with pressure and only vary with T
  ! (although setting up simulations mostly to be on liquid-gas phase boundary of water)
  
  real(dp), paramter:: t_new = (/ 273.16,       280.78938776, 288.41877551, 296.04816327,
       303.67755102, 311.30693878, 318.93632653, 326.56571429,
       334.19510204, 341.8244898 , 349.45387755, 357.08326531,
       364.71265306, 372.34204082, 379.97142857, 387.60081633,
       395.23020408, 402.85959184, 410.48897959, 418.11836735,
       425.7477551 , 433.37714286, 441.00653061, 448.63591837,
       456.26530612, 463.89469388, 471.52408163, 479.15346939,
       486.78285714, 494.4122449 , 502.04163265, 509.67102041,
       517.30040816, 524.92979592, 532.55918367, 540.18857143,
       547.81795918, 555.44734694, 563.07673469, 570.70612245,
       578.3355102 , 585.96489796, 593.59428571, 601.22367347,
       608.85306122, 616.48244898, 624.11183673, 631.74122449,
639 .37061224, 647./)

  ! DATA FROM WAGNER + PRUSS 2002
  real(dp), parameter :: p_sat_new = (/6.12000000e+02, 1.04923061e+03, 1.73736857e+03, 2.79457306e+03,
       4.38096735e+03, 6.69692367e+03, 1.00008673e+04, 1.46155971e+04,
       2.09377363e+04, 2.94622265e+04, 4.07732522e+04, 5.55243931e+04,
       7.44916012e+04, 9.85580310e+04, 1.28727571e+05, 1.66224367e+05,
       2.12199347e+05, 2.68034012e+05, 3.35212661e+05, 4.15350755e+05,
       5.10320188e+05, 6.21953600e+05, 7.52159967e+05, 9.03042755e+05,
       1.07685306e+06, 1.27590935e+06, 1.50295616e+06, 1.76023653e+06,
       2.05046657e+06, 2.37629837e+06, 2.74072951e+06, 3.14720873e+06,
       3.59839527e+06, 4.09752347e+06, 4.64775388e+06, 5.25272114e+06,
       5.91629812e+06, 6.64237024e+06, 7.43445653e+06, 8.29666367e+06,
       9.23353049e+06, 1.02501735e+07, 1.13513457e+07, 1.25432351e+07,
       1.38311388e+07, 1.52229065e+07, 1.67260943e+07, 1.83520694e+07,
       2.01142616e+07, 2.20380000e+07/)

  ! DATA FROM WAGNER + PRUSS 2002
  real(dp), parameter :: l_new = (/2500919.        , 2482783.54571429, 2464715.33959184,
       2446658.73265306, 2428558.97755102, 2410380.41632653,
       2392099.19836735, 2373684.16285714, 2355093.68285714,
       2336317.51020408, 2317307.03673469, 2298030.46489796,
       2278448.94122449, 2258531.69632653, 2238234.6       ,
       2217489.75714286, 2196278.28122449, 2174530.78816327,
       2152205.97510204, 2129254.32244898, 2105612.7877551 ,
       2081223.54857143, 2056042.58653061, 2029995.68612245,
       2003033.58163265, 1975076.15959184, 1946059.23469388,
       1915904.70897959, 1884537.04285714, 1851858.71836735,
       1817785.8644898 , 1782164.29795918, 1744917.46530612,
       1705877.86938776, 1664890.51020408, 1621779.68571429,
       1576298.62857143, 1528190.13877551, 1477145.91428571,
       1422788.81632653, 1364632.69387755, 1302076.26122449,
       1234208.65714286, 1160005.24081633, 1077856.57142857,
        985309.91836735,  878148.63673469,  747604.97959184,
        571155.15918367,  119120.        /)

  ! DATA FROM WAGNER + PRUSS 2002
  real(dp), parameter :: phase_grad_new = (/19.84498763, 19.17353919, 18.53789423, 17.93565645, 17.36465413,
       16.82291155, 16.30862474, 15.82014078, 15.35594009, 14.91462126,
       14.49488801, 14.09553799, 13.71545305, 13.35359096, 13.00897814,
       12.68070341, 12.36791267, 12.06980415, 11.78562448, 11.5146652 ,
       11.25625983, 11.00978139, 10.77464026, 10.55028249, 10.33618842,
       10.13187159,  9.936878  ,  9.75078568,  9.57320455,  9.40377664,
        9.24217669,  9.08811314,  8.94132966,  8.80160724,  8.66876713,
        8.54267471,  8.4232447 ,  8.31044837,  8.20432318,  8.10498658,
        8.01265563,  7.9276764 ,  7.85056951,  7.78210502,  7.72343408,
        7.67634348,  7.6438164 ,  7.63154147,  7.65373997,  7.82698973/)

  ! DATA FROM WAGNER + PRUSS 2002
  real(dp), parameter :: cpl_new = (/4219.9       ,    4199.86069388,    4188.56028571,
          4182.57832653,    4179.9644898 ,    4179.56534694,
          4180.48726531,    4182.598     ,    4185.58779592,
          4189.50346939,    4194.21771429,    4199.96661224,
          4206.77702041,    4214.79334694,    4224.06285714,
          4234.80122449,    4246.99134694,    4260.97620408,
          4276.6757551 ,    4294.29591837,    4314.01893878,
          4336.03142857,    4360.52220408,    4387.58469388,
          4417.60102041,    4450.82085714,    4487.52040816,
          4528.25942857,    4573.29285714,    4623.28571429,
          4678.92681633,    4741.18722449,    4810.88391837,
          4889.38126531,    4978.3177551 ,    5079.72485714,
          5196.45093878,    5332.17195918,    5491.68804082,
          5681.85367347,    5912.42412245,    6197.87134694,
          6561.79714286,    7041.54922449,    7706.42877551,
          8702.94044898,   10396.73836735,   13939.64244898,
         24425.1755102 , 3905200.        /)

  ! DATA FROM WAGNER + PRUSS 2002
  real(dp), parameter :: cpv_new = (/1.88440000e+03, 1.89216833e+03, 1.90048159e+03, 1.90925780e+03,
       1.91869694e+03, 1.92882971e+03, 1.94005131e+03, 1.95259000e+03,
       1.96679996e+03, 1.98310510e+03, 2.00188008e+03, 2.02350396e+03,
       2.04829429e+03, 2.07678527e+03, 2.10947143e+03, 2.14674420e+03,
       2.18905820e+03, 2.23695927e+03, 2.29076735e+03, 2.35079429e+03,
       2.41731718e+03, 2.49057143e+03, 2.57072151e+03, 2.65789922e+03,
       2.75243571e+03, 2.85464678e+03, 2.96498502e+03, 3.08418620e+03,
       3.21307829e+03, 3.35291510e+03, 3.50517845e+03, 3.67213216e+03,
       3.85613531e+03, 4.06041322e+03, 4.28889388e+03, 4.54689229e+03,
       4.84128184e+03, 5.18122135e+03, 5.57852784e+03, 6.05008694e+03,
       6.61981641e+03, 7.32338278e+03, 8.21909486e+03, 9.39755139e+03,
       1.10225306e+04, 1.34169445e+04, 1.73250322e+04, 2.50556661e+04,
       4.89789788e+04, 5.33410000e+06/)

  ! DATA FROM WAGNER + PRUSS 2002
  real(dp), parameter :: hl = (/1.00000000e+00, 3.21110339e+04, 6.41068318e+04, 9.60384429e+04,
       1.27939002e+05, 1.59829004e+05, 1.91722781e+05, 2.23628666e+05,
       2.55555795e+05, 2.87510612e+05, 3.19500016e+05, 3.51532339e+05,
       3.83615557e+05, 4.15758728e+05, 4.47971257e+05, 4.80265459e+05,
       5.12653213e+05, 5.45145449e+05, 5.77757033e+05, 6.10502453e+05,
       6.43398302e+05, 6.76461309e+05, 7.09709042e+05, 7.43159359e+05,
       7.76833969e+05, 8.10755387e+05, 8.44948557e+05, 8.79439328e+05,
       9.14254357e+05, 9.49426404e+05, 9.84988507e+05, 1.02098899e+06,
       1.05745496e+06, 1.09445205e+06, 1.13202914e+06, 1.17024511e+06,
       1.20919340e+06, 1.24895304e+06, 1.28964437e+06, 1.33139251e+06,
       1.37437583e+06, 1.41879290e+06, 1.46498080e+06, 1.51329552e+06,
       1.56431465e+06, 1.61895078e+06, 1.67884502e+06, 1.74756023e+06,
       1.83363516e+06, 2.02944000e+06/)
contains
  
    subroutine binary_search(arr, targ, output)
      real(dp), intent(in) :: arr(:)
      real(dp), intent(in) :: targ
      integer, intent(out) :: output

      integer :: hi, lo, mid, i
      lo = 1
      hi = size(arr)

      do while(hi-lo .gt. 1)
         mid = (lo + hi)/2
         
         if (arr(mid) .lt. targ) then
            lo = mid
         else
            hi = mid
         endif
         
      enddo
      output = lo

      
    end subroutine binary_search
    
    subroutine find_var_lin(T_target, var, output_var)
      real(dp), intent(in) :: T_target
      real(dp), intent(in) :: var(:)
      real(dp), intent(out) :: output_var

            
      integer :: index
      logical :: reverse
      
      ! Find index nearest T_target
      call binary_search(T, T_target, index)

      call linear_interp(T_target, T(index), T(index+1), var(index), var(index+1),&
           output_var)
    end subroutine find_var_lin
    
    subroutine find_var_loglin(T_target, var, output_var)
      real(dp), intent(in) :: T_target
      real(dp), intent(in) :: var(:)
      real(dp), intent(out) :: output_var
      
      integer :: index
      real(dp) :: output_varlog

      ! Find index nearest T_target
      call binary_search(T, T_target, index)

      output_varlog = log(var(index)) + (T_target-T(index))/(T(index+1) - T(index))*&
           (log(var(index+1)) - log(var(index)))
      output_var = exp(output_varlog)
      
    end subroutine find_var_loglin
    

    subroutine find_var_simplified(T_target, var, output_var)

      character(*), intent(in) :: var ! Variable to be specified
      real(dp), intent(in) :: T_target ! Target input temperature
      real(dp), intent(out) :: output_var ! Output variable

      real(dp) :: output_varlog
      integer :: i
      i = 1 + floor((T_target - Ttp)/(T_end - Ttp)*(n_table - 1))

      ! Limit values inside table range
      i = min(i,n_table-1)
      
      select case(var)
      case('satur')
         output_varlog = log(var(index)) + (T_target-T_new(i))/(T_new(i+1) - T_new(i))*&
           (log(p_sat_new(i+1)) - log(p_sat_new(i)))
         output_var = exp(output_varlog)
      case('lheat')
         call linear_interp(T_target, T_new(i), T_new(i+1), l_new(i), l_new(i+1),output_var)
      case('phase_grad')
         call linear_interp(T_target, T_new(i), T_new(i+1), phase_grad_new(i),
         phase_grad_new(i+1), output_var)
      case('cp_v')
         call linear_interp(T_target, T_new(i), T_new(i+1), cpv_new(i), cpv_new(i+1)
      case('cp_l')
         call linear_interp(T_target, T_new(i), T_new(i+1), cpl_new(i), cpl_new(i+1)
      case ('hl')
         call linear_interp(T_target, T_new(i), T_new(i+1), hl(i), hl(i+1)
      end select

      
    end subroutine find_var_simplified
    
end module tables
